!function(e,t){"use strict";const a=300,r=200,s=3,n=1e3,o={isLoading:!1,currentRequest:null,retryCount:0,cache:new Map};function c(){if("undefined"==typeof apsData)return void console.error("APS: apsData not localized. Script may not be properly enqueued.");const e=t.querySelector(".aps-showcase-container");e?(function(e){e._cachedElements={searchInput:e.querySelector("#aps-search-input"),searchSpinner:e.querySelector(".aps-search-spinner"),tabs:e.querySelectorAll(".aps-tab"),tags:e.querySelectorAll(".aps-tags-grid .aps-tag"),clearBtn:e.querySelector(".aps-clear-all"),sortSelect:e.querySelector(".aps-sort-select"),grid:e.querySelector(".aps-cards-grid"),pagination:e.querySelector(".aps-pagination"),resultsInfo:e.querySelector(".aps-results-info")}}(e),function(e){const t=e._cachedElements,r=t.searchInput,s=t.searchSpinner;if(!r)return;let n;r.addEventListener("input",function(t){clearTimeout(n),s&&s.classList.add("active"),n=setTimeout(()=>{const a=t.target.value.trim();p(e,{search:a}),s&&s.classList.remove("active")},a)}),r.addEventListener("keydown",function(t){"Escape"===t.key&&(this.value="",p(e,{search:""}),this.blur())})}(e),function(e){e.querySelectorAll(".aps-tab").forEach(t=>{t.addEventListener("click",function(){this.classList.contains("active")||(e.querySelectorAll(".aps-tab").forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-selected","false")}),this.classList.add("active"),this.setAttribute("aria-selected","true"),p(e,{category:this.dataset.category,page:1}))})}),e.querySelectorAll(".aps-tags-grid .aps-tag").forEach(t=>{t.addEventListener("click",function(){this.classList.toggle("active");const t=this.classList.contains("active");this.setAttribute("aria-pressed",t.toString()),p(e,{tags:i(e),page:1})})});const t=e.querySelector(".aps-clear-all");t&&t.addEventListener("click",function(t){t.preventDefault(),l(e)})}(e),function(e){const t=e.querySelector(".aps-sort-select");if(!t)return;t.addEventListener("change",function(){p(e,{sort:this.value})})}(e),function(e){e.addEventListener("click",function(t){const a=t.target.closest(".aps-pagination-number, .aps-pagination-prev, .aps-pagination-next");if(!a||a.classList.contains("disabled")||a.classList.contains("active"))return;const r=parseInt(a.dataset.page,10);if(isNaN(r))return;p(e,{page:r});const s=e.querySelector(".aps-cards-grid");s?.scrollIntoView({behavior:"smooth",block:"start"})})}(e),function(e){e.querySelectorAll(".aps-tags-grid").forEach(e=>{e.addEventListener("keydown",function(e){const a=Array.from(this.querySelectorAll(".aps-tag")),r=a.indexOf(t.activeElement);"ArrowRight"===e.key&&r<a.length-1?(e.preventDefault(),a[r+1].focus()):"ArrowLeft"===e.key&&r>0&&(e.preventDefault(),a[r-1].focus())})})}(e)):console.warn("APS: Showcase container not found")}function i(e){return Array.from(e.querySelectorAll(".aps-tags-grid .aps-tag.active")).map(e=>e.dataset.tag)}function l(e){e.querySelectorAll(".aps-tab").forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-selected","false")});const t=e.querySelector('.aps-tab[data-category="all"]');t&&(t.classList.add("active"),t.setAttribute("aria-selected","true")),e.querySelectorAll(".aps-tags-grid .aps-tag").forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-pressed","false")});const a=e.querySelector(".aps-sort-select");a&&(a.value="featured");const r=e.querySelector("#aps-search-input");r&&(r.value=""),p(e,{category:"all",tags:[],search:"",sort:"featured",page:1})}function p(a,r={}){o.isLoading&&o.currentRequest?.abort();const c=function(e){const t=e.querySelector(".aps-tab.active"),a=e.querySelector(".aps-sort-select"),r=e.querySelector("#aps-search-input");return{category:t?.dataset.category||"all",tags:i(e),sort:a?.value||"featured",search:r?.value.trim()||"",page:parseInt(e.dataset.currentPage,10)||1,per_page:parseInt(e.dataset.perPage,10)||12}}(a),l={...c,...r},g=JSON.stringify(l);if(o.cache.has(g))return void u(a,o.cache.get(g),l);!function(t){if(!e.history||!e.URLSearchParams)return;const a=new URLSearchParams;"all"!==t.category&&a.set("aps_category",t.category);t.tags.length&&a.set("aps_tags",t.tags.join(","));"featured"!==t.sort&&a.set("aps_sort",t.sort);t.search&&a.set("aps_search",t.search);t.page>1&&a.set("aps_page",t.page);const r=`${e.location.pathname}${a.toString()?"?"+a.toString():""}`;e.history.replaceState({aps:t},"",r)}(l);const h=new FormData;h.append("action","aps_filter_products"),h.append("nonce",apsData.nonce),h.append("category",l.category),h.append("tags",JSON.stringify(l.tags)),h.append("sort",l.sort),h.append("search",l.search),h.append("page",l.page),h.append("per_page",l.per_page);const f=new AbortController;o.currentRequest=f,d(a,!0),fetch(apsData.ajaxUrl,{method:"POST",body:h,credentials:"same-origin",signal:f.signal}).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(e=>{if(!e.success)throw new Error(e.data?.message||"Unknown error");o.cache.set(g,e.data),o.cache.size>50&&o.cache.delete(o.cache.keys().next().value),u(a,e.data,l),o.retryCount=0}).catch(e=>{"AbortError"!==e.name&&(console.error("APS: Filter error",e),o.retryCount<s?(o.retryCount++,setTimeout(()=>p(a,r),n*o.retryCount)):(!function(e,a){const r=e._cachedElements,s=r.grid||e.querySelector(".aps-cards-grid");if(!s)return;for(;s.firstChild;)s.removeChild(s.firstChild);const n=t.createElement("div");n.className="aps-error";const o=t.createElement("p");o.textContent=apsData.i18n?.error||a||"An error occurred",n.appendChild(o);const c=t.createElement("button");c.type="button",c.className="aps-retry-btn",c.textContent=apsData.i18n?.retry||"Retry",c.addEventListener("click",function(){location.reload()}),n.appendChild(c),s.appendChild(n)}(a,e.message),o.retryCount=0))}).finally(()=>{d(a,!1),o.isLoading=!1})}function u(e,a,s){const n=e._cachedElements,o=n.grid||e.querySelector(".aps-cards-grid"),c=n.pagination||e.querySelector(".aps-pagination");o&&(o.style.opacity="0",setTimeout(()=>{for(;o.firstChild;)o.removeChild(o.firstChild);if(a.products&&a.products.trim()){const e=(new DOMParser).parseFromString(a.products,"text/html"),r=t.createDocumentFragment();for(;e.body.firstChild;)r.appendChild(e.body.firstChild);o.appendChild(r)}else{const e=t.createElement("p");e.className="aps-no-products",e.textContent=apsData.i18n.noProducts||"No products found",o.appendChild(e)}c&&a.pagination&&(c.outerHTML=a.pagination),e.dataset.currentPage=s.page,e.dataset.totalPages=a.total_pages||1,o.style.opacity="1";const r=e.querySelector(".aps-results-info");r&&void 0!==a.count&&(r.textContent=`${a.count} products found`)},r))}function d(e,t){o.isLoading=t;const a=e._cachedElements.grid||e.querySelector(".aps-cards-grid");a&&(t?a.classList.add("loading"):a.classList.remove("loading"))}"loading"===t.readyState?t.addEventListener("DOMContentLoaded",c):c(),e.APS=e.APS||{},e.APS.Frontend={refresh:function(e){p(e||t.querySelector(".aps-showcase-container"),{})},clearFilters:function(e){l(e||t.querySelector(".aps-showcase-container"))}}}(window,document);