!function(e,t){"use strict";const a=300,r=200,s=3,n=1e3,o={isLoading:!1,currentRequest:null,retryCount:0,cache:new Map};function c(){if("undefined"==typeof apsData)return void console.error("APS: apsData not localized. Script may not be properly enqueued.");const e=t.querySelector(".aps-showcase-container");e?(function(e){const t=e.querySelector("#aps-search-input"),r=e.querySelector(".aps-search-spinner");if(!t)return;let s;t.addEventListener("input",function(t){clearTimeout(s),r?.classList.add("active"),s=setTimeout(()=>{const a=t.target.value.trim();u(e,{search:a}),r?.classList.remove("active")},a)}),t.addEventListener("keydown",function(t){"Escape"===t.key&&(this.value="",u(e,{search:""}),this.blur())})}(e),function(e){e.querySelectorAll(".aps-tab").forEach(t=>{t.addEventListener("click",function(){this.classList.contains("active")||(e.querySelectorAll(".aps-tab").forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-selected","false")}),this.classList.add("active"),this.setAttribute("aria-selected","true"),u(e,{category:this.dataset.category,page:1}))})}),e.querySelectorAll(".aps-tags-grid .aps-tag").forEach(t=>{t.addEventListener("click",function(){this.classList.toggle("active");const t=this.classList.contains("active");this.setAttribute("aria-pressed",t.toString()),u(e,{tags:i(e),page:1})})});const t=e.querySelector(".aps-clear-all");t&&t.addEventListener("click",function(t){t.preventDefault(),l(e)})}(e),function(e){const t=e.querySelector(".aps-sort-select");if(!t)return;t.addEventListener("change",function(){u(e,{sort:this.value})})}(e),function(e){e.addEventListener("click",function(t){const a=t.target.closest(".aps-pagination-number, .aps-pagination-prev, .aps-pagination-next");if(!a||a.classList.contains("disabled")||a.classList.contains("active"))return;const r=parseInt(a.dataset.page,10);if(isNaN(r))return;u(e,{page:r});const s=e.querySelector(".aps-cards-grid");s?.scrollIntoView({behavior:"smooth",block:"start"})})}(e),function(e){e.querySelectorAll(".aps-tags-grid").forEach(e=>{e.addEventListener("keydown",function(e){const a=Array.from(this.querySelectorAll(".aps-tag")),r=a.indexOf(t.activeElement);"ArrowRight"===e.key&&r<a.length-1?(e.preventDefault(),a[r+1].focus()):"ArrowLeft"===e.key&&r>0&&(e.preventDefault(),a[r-1].focus())})})}(e)):console.warn("APS: Showcase container not found")}function i(e){return Array.from(e.querySelectorAll(".aps-tags-grid .aps-tag.active")).map(e=>e.dataset.tag)}function l(e){e.querySelectorAll(".aps-tab").forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-selected","false")});const t=e.querySelector('.aps-tab[data-category="all"]');t&&(t.classList.add("active"),t.setAttribute("aria-selected","true")),e.querySelectorAll(".aps-tags-grid .aps-tag").forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-pressed","false")});const a=e.querySelector(".aps-sort-select");a&&(a.value="featured");const r=e.querySelector("#aps-search-input");r&&(r.value=""),u(e,{category:"all",tags:[],search:"",sort:"featured",page:1})}function u(t,a={}){o.isLoading&&o.currentRequest?.abort();const r=function(e){const t=e.querySelector(".aps-tab.active"),a=e.querySelector(".aps-sort-select"),r=e.querySelector("#aps-search-input");return{category:t?.dataset.category||"all",tags:i(e),sort:a?.value||"featured",search:r?.value.trim()||"",page:parseInt(e.dataset.currentPage,10)||1,per_page:parseInt(e.dataset.perPage,10)||12}}(t),c={...r,...a},l=JSON.stringify(c);if(o.cache.has(l))return void p(t,o.cache.get(l),c);!function(t){if(!e.history||!e.URLSearchParams)return;const a=new URLSearchParams;"all"!==t.category&&a.set("aps_category",t.category);t.tags.length&&a.set("aps_tags",t.tags.join(","));"featured"!==t.sort&&a.set("aps_sort",t.sort);t.search&&a.set("aps_search",t.search);t.page>1&&a.set("aps_page",t.page);const r=`${e.location.pathname}${a.toString()?"?"+a.toString():""}`;e.history.replaceState({aps:t},"",r)}(c);const g=new FormData;g.append("action","aps_filter_products"),g.append("nonce",apsData.nonce),g.append("category",c.category),g.append("tags",JSON.stringify(c.tags)),g.append("sort",c.sort),g.append("search",c.search),g.append("page",c.page),g.append("per_page",c.per_page);const y=new AbortController;o.currentRequest=y,d(t,!0),fetch(apsData.ajaxUrl,{method:"POST",body:g,credentials:"same-origin",signal:y.signal}).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(e=>{if(!e.success)throw new Error(e.data?.message||"Unknown error");o.cache.set(l,e.data),o.cache.size>50&&o.cache.delete(o.cache.keys().next().value),p(t,e.data,c),o.retryCount=0}).catch(e=>{"AbortError"!==e.name&&(console.error("APS: Filter error",e),o.retryCount<s?(o.retryCount++,setTimeout(()=>u(t,a),n*o.retryCount)):(!function(e){const t=e.querySelector(".aps-cards-grid");t&&(t.innerHTML=`\n                <div class="aps-error">\n                    <p>${apsData.i18n.error}</p>\n                    <button type="button" class="aps-retry-btn" onclick="location.reload()">\n                        ${apsData.i18n.retry||"Retry"}\n                    </button>\n                </div>\n            `)}(t,e.message),o.retryCount=0))}).finally(()=>{d(t,!1),o.isLoading=!1})}function p(e,t,a){const s=e.querySelector(".aps-cards-grid"),n=e.querySelector(".aps-pagination");s&&(s.style.opacity="0",setTimeout(()=>{t.products&&t.products.trim()?s.innerHTML=t.products:s.innerHTML=`<p class="aps-no-products">${apsData.i18n.noProducts}</p>`,n&&t.pagination&&(n.outerHTML=t.pagination),e.dataset.currentPage=a.page,e.dataset.totalPages=t.total_pages||1,s.style.opacity="1";const r=e.querySelector(".aps-results-info");r&&void 0!==t.count&&(r.textContent=`${t.count} products found`)},r))}function d(e,t){o.isLoading=t;const a=e.querySelector(".aps-cards-grid");t?a?.classList.add("loading"):a?.classList.remove("loading")}"loading"===t.readyState?t.addEventListener("DOMContentLoaded",c):c(),e.APS={refresh:e=>u(e||t.querySelector(".aps-showcase-container"),{}),clearFilters:e=>l(e||t.querySelector(".aps-showcase-container"))}}(window,document);