!function(e){"use strict";if("undefined"==typeof wp||void 0===wp.i18n)return void console.error("APS: WordPress i18n not loaded");if(void 0===window.APS||!window.APS.Utils)return void console.error("APS: Utils not loaded");const{__:t}=wp.i18n,a=50,s=300,o=300,i=40,n=13,d=27;function r(a){const s=a.uploadBtnId,o=a.urlInputId,i=a.hiddenUrlId,n=a.previewId,d=a.placeholderId,r=a.removeBtnId,l=a.mediaTitle||t("Select Image","affiliate-product-showcase"),c=e(`#${s}`);c.on("click",function(a){if(a.preventDefault(),a.stopPropagation(),"undefined"==typeof wp||void 0===wp.media)return void window.APS.Utils.showNotice("error",t("WordPress media library is not loaded. Please refresh page.","affiliate-product-showcase"));let s=c.data("mediaUploader");s||(s=wp.media({title:l,button:{text:t("Use This Image","affiliate-product-showcase")},multiple:!1}),s.on("select",function(){const a=s.state().get("selection").first().toJSON(),l=window.APS.Utils.sanitizeUrl(a.url);l?(e(`#${i}`).val(l),e(`#${o}`).val(l),e(`#${n}`).html('<img src="'+window.APS.Utils.escapeHtml(l)+'" alt="">').addClass("has-image").show(),e(`${d}`).hide(),e(`#${r}`).removeClass("aps-hidden")):window.APS.Utils.showNotice("error",t("Invalid image URL from media library. Please try a different image.","affiliate-product-showcase"))}),c.data("mediaUploader",s)),s.open()}),e(`#${o}`).on("change",function(){const a=e(this).val().trim(),s=window.APS.Utils.sanitizeUrl(a);s?(e(`#${i}`).val(s),e(`#${n}`).html('<img src="'+window.APS.Utils.escapeHtml(s)+'" alt="">').addClass("has-image").show(),e(`${d}`).hide(),e(`#${r}`).removeClass("aps-hidden")):a&&(window.APS.Utils.showNotice("error",t("Invalid URL. Only http, https, and data URLs are allowed.","affiliate-product-showcase")),e(this).val(""))}),e(`#${r}`).on("click",function(){e(`#${i}`).val(""),e(`#${o}`).val(""),e(`#${n}`).html("").removeClass("has-image").hide(),e(`${d}`).show(),e(this).addClass("aps-hidden")})}class l{constructor(t){this.selectedItems=[],this.config={dropdownId:"",selectedContainerId:"",hiddenInputId:"",itemSelector:".dropdown-item",renderItem:e=>e.text(),...t},this.$dropdown=e(`#${this.config.dropdownId}`),this.$selectedContainer=e(`#${this.config.selectedContainerId}`),this.$hiddenInput=e(`#${this.config.hiddenInputId}`),this.init()}init(){this.bindEvents(),this.renderSelected()}bindEvents(){const t=this;this.$dropdown.on("click.aps",this.config.itemSelector,function(a){const s=e(this).data("value");void 0!==s&&t.addItem(s)}),this.$selectedContainer.on("click.aps",".remove-tag",function(a){a.preventDefault();const s=e(this).data("index");void 0!==s&&t.removeItem(s)}),this.$selectedContainer.on("keydown.aps",".remove-tag",function(a){if("Enter"===a.key||" "===a.key){a.preventDefault();const s=e(this).data("index");void 0!==s&&t.removeItem(s)}})}destroy(){this.$dropdown.off(".aps"),this.$selectedContainer.off(".aps")}addItem(e){this.selectedItems.includes(e)||(this.selectedItems.push(e),this.renderSelected(),this.updateHiddenInput())}removeItem(e){this.selectedItems.splice(e,1),this.renderSelected(),this.updateHiddenInput()}renderSelected(){const a=this;this.$selectedContainer.empty(),this.selectedItems.forEach(function(s,o){const i=a.getItemText(s),n=e('<span class="aps-tag"></span>'),d=e('<span class="remove-tag" role="button" tabindex="0"></span>').attr("aria-label",t("Remove item","affiliate-product-showcase")).attr("data-index",o).text("Ã—");n.html(i).append(d),a.$selectedContainer.append(n)})}getItemText(e){const t=String(e).replace(/"/g,'\\"'),a=this.$dropdown.find(`${this.config.itemSelector}[data-value="${t}"]`);return this.config.renderItem(a)}updateHiddenInput(){this.$hiddenInput.val(this.selectedItems.join(","))}setItems(e){this.selectedItems=[...e],this.renderSelected(),this.updateHiddenInput()}}e(document).ready(function(){const c="undefined"!=typeof apsAddProductData?apsAddProductData:null,p={wordCount:e("#aps-word-count"),shortDescription:e("#aps-short-description"),discountInput:e("#aps-discount"),currentPrice:e("#aps-current-price"),originalPrice:e("#aps-original-price"),featuresList:e("#aps-features-list"),featuresInput:e("#aps-features-input"),newFeatureInput:e("#aps-new-feature")};e(".aps-quick-nav .nav-link").on("click",function(t){t.preventDefault();const o=e(this).attr("href"),i=e(o);i.length&&i.offset()&&e("html, body").animate({scrollTop:i.offset().top-a},s)});const u=p.wordCount;p.shortDescription.on("input",window.APS.Utils.debounce(function(){const t=e(this).val().trim(),a=""===t?0:t.split(/\s+/).length,s=Math.min(a,i);u.text(s),a>i?u.removeClass("u-text-muted").addClass("u-text-danger"):u.removeClass("u-text-danger").addClass("u-text-muted")},o)),function(){const e=p.shortDescription.val().trim(),t=""===e?0:e.split(/\s+/).length;u.text(Math.min(t,i)),t>i&&u.removeClass("u-text-muted").addClass("u-text-danger")}();const f=p.discountInput,h=p.currentPrice,m=p.originalPrice;function v(){const e=parseFloat(h.val())||0,a=parseFloat(m.val())||0;if(e>0&&a>0&&a>e){const s=Math.round((a-e)/a*100);f.val(s+"% "+t("OFF","affiliate-product-showcase")),f.removeClass("u-text-muted").addClass("u-text-success")}else f.val("0% "+t("OFF","affiliate-product-showcase")),f.removeClass("u-text-success").addClass("u-text-muted")}h.on("input",v),m.on("input",v),v();const w=new l({dropdownId:"aps-categories-dropdown",selectedContainerId:"aps-selected-categories",hiddenInputId:"aps-categories-input",renderItem:function(e){return window.APS.Utils.escapeHtml(e.find(".taxonomy-name").text())}});c&&c.isEditing&&c.productData&&c.productData.categories&&Array.isArray(c.productData.categories)&&w.setItems(c.productData.categories);const g=new l({dropdownId:"aps-ribbons-dropdown",selectedContainerId:"aps-selected-ribbons",hiddenInputId:"aps-ribbons-input",renderItem:function(t){const a=t.find(".ribbon-badge-preview"),s=a.css("color"),o=a.css("background-color"),i=t.find(".ribbon-name").text(),n=t.find(".ribbon-icon").text(),d=e("<span>").addClass("ribbon-tag-preview").css({color:s,backgroundColor:o});return n&&d.append(e("<span>").addClass("ribbon-icon").text(n)),d.append(document.createTextNode(i)),d.prop("outerHTML")}});if(c&&c.isEditing&&c.productData&&c.productData.ribbons&&Array.isArray(c.productData.ribbons)&&g.setItems(c.productData.ribbons),e(".aps-multi-select .aps-multiselect-input").on("focus click",function(){e(this).siblings(".aps-dropdown").slideDown(s),e(this).closest(".aps-multi-select").attr("aria-expanded","true")}),e(document).on("click.aps",function(t){e(t.target).closest(".aps-multi-select").length||(e(".aps-dropdown").slideUp(s),e(".aps-multi-select").attr("aria-expanded","false"))}),e(".aps-multiselect-input").on("keydown",function(t){const a=e(this).siblings(".aps-dropdown"),o=a.find(".dropdown-item"),i=o.index(o.filter(".focused"));switch(t.key){case"ArrowDown":t.preventDefault();{const e=Math.min(i+1,o.length-1);o.removeClass("focused").eq(e).addClass("focused")}break;case"ArrowUp":t.preventDefault();{const e=Math.max(i-1,0);o.removeClass("focused").eq(e).addClass("focused")}break;case"Enter":case" ":t.preventDefault(),o.filter(".focused").click();break;case"Escape":t.preventDefault(),a.slideUp(s),e(this).closest(".aps-multi-select").attr("aria-expanded","false")}}),r({uploadBtnId:"aps-upload-image-btn",urlInputId:"aps-image-url-input",hiddenUrlId:"aps-image-url",previewId:"aps-image-preview",placeholderId:"#aps-image-upload .upload-placeholder",removeBtnId:"aps-remove-image-btn",mediaTitle:t("Select Image","affiliate-product-showcase")}),r({uploadBtnId:"aps-upload-brand-btn",urlInputId:"aps-brand-url-input",hiddenUrlId:"aps-brand-image-url",previewId:"aps-brand-preview",placeholderId:"#aps-brand-upload .upload-placeholder",removeBtnId:"aps-remove-brand-btn",mediaTitle:t("Select Brand Image","affiliate-product-showcase")}),e("[data-image-url]").each(function(){const t=e(this).data("image-url"),a=window.APS.Utils.sanitizeUrl(t);if(a){const t=a.replace(/[()'"\\]/g,"\\$&");e(this).addClass("has-bg-image").css("--bg-image-url",'url("'+t+'")')}}),c&&c.isEditing&&c.productData){const t=c.productData;t.rating&&e("#aps-rating").val(t.rating),t.views&&e("#aps-views").val(t.views),t.reviews&&e("#aps-reviews").val(t.reviews),t.user_count&&e("#aps-user-count").val(t.user_count)}!function(){const a=e("#aps-add-feature"),s=e("#aps-new-feature"),o=e("#aps-features-list"),i=e("#aps-features-input"),r=e('<div id="aps-features-a11y-status" class="screen-reader-text" aria-live="polite"></div>');function l(e){r.text(e),setTimeout(()=>r.text(""),1e3)}o.before(r);let c=[];try{const e=i.val();e&&(c=JSON.parse(e))}catch(e){console.error("APS: Failed to parse features JSON",e),c=[]}function p(){i.val(JSON.stringify(c))}function u(){o.empty(),c.forEach(function(a,s){const i="object"==typeof a?a.text:a,n="object"==typeof a&&a.bold,d=e("<div>").addClass("feature-item").attr("data-index",s).attr("data-bold",n?"1":"0"),r=e("<div>").addClass("feature-item-content");r.append(e("<span>").addClass("dashicons dashicons-menu drag-handle").attr("title",t("Drag to reorder","affiliate-product-showcase")).attr("aria-hidden","true")),r.append(e("<span>").addClass("feature-text").toggleClass("is-bold",n).text(i));const l=e("<div>").addClass("feature-actions"),p=e("<button>").attr("type","button").addClass("feature-btn move-btn move-up").attr("title",t("Move up","affiliate-product-showcase")).attr("aria-label",t("Move feature up","affiliate-product-showcase")).prop("disabled",0===s);p.append(e("<span>").addClass("dashicons dashicons-arrow-up-alt2 aps-icon-sm"));const u=e("<button>").attr("type","button").addClass("feature-btn move-btn move-down").attr("title",t("Move down","affiliate-product-showcase")).attr("aria-label",t("Move feature down","affiliate-product-showcase")).prop("disabled",s===c.length-1);u.append(e("<span>").addClass("dashicons dashicons-arrow-down-alt2 aps-icon-sm"));const f=e("<button>").attr("type","button").addClass("feature-btn bold-btn").toggleClass("active",n).attr("title",t("Toggle bold","affiliate-product-showcase")).attr("aria-label",t("Toggle bold style","affiliate-product-showcase")).attr("aria-pressed",n);f.append(e("<span>").addClass("dashicons dashicons-editor-bold aps-icon-sm"));const h=e("<button>").attr("type","button").addClass("remove-feature").attr("aria-label",t("Remove feature","affiliate-product-showcase")).html("&times;");l.append(p,u,f,h),d.append(r,l),o.append(d)}),p()}function f(){const e=s.val().trim();if(e){c.some(function(t){return("object"==typeof t?t.text:t)===e})||(c.push({text:e,bold:!1}),u(),s.val(""),l(t("Feature added:","affiliate-product-showcase")+" "+e))}}a.on("click",f),s.on("keypress",function(e){e.which===n&&(e.preventDefault(),f())}),o.on("click",".remove-feature",function(){const a=e(this).closest(".feature-item").data("index"),s="object"==typeof c[a]?c[a].text:c[a];c.splice(a,1),u(),l(t("Feature removed:","affiliate-product-showcase")+" "+s)}),o.on("click",".bold-btn",function(){const t=e(this).closest(".feature-item"),a=t.data("index"),s=t.find(".feature-text");"object"==typeof c[a]?c[a].bold=!c[a].bold:c[a]={text:c[a],bold:!0},s.toggleClass("is-bold"),e(this).toggleClass("active"),t.attr("data-bold",c[a].bold?"1":"0"),p()}),o.on("click",".move-up:not(:disabled)",function(){const a=e(this).closest(".feature-item").data("index");if(a>0){const e=c[a];c[a]=c[a-1],c[a-1]=e,u(),o.find('.feature-item[data-index="'+(a-1)+'"] .move-up').focus(),l(t("Moved up to position","affiliate-product-showcase")+" "+a)}}),o.on("click",".move-down:not(:disabled)",function(){const a=e(this).closest(".feature-item").data("index");if(a<c.length-1){const e=c[a];c[a]=c[a+1],c[a+1]=e,u(),o.find('.feature-item[data-index="'+(a+1)+'"] .move-down').focus(),l(t("Moved down to position","affiliate-product-showcase")+" "+(a+2))}});let h=null;o.on("dragstart",".feature-item",function(t){h=e(this),e(this).addClass("dragging"),t.originalEvent.dataTransfer.effectAllowed="move"}),o.on("dragend",".feature-item",function(){e(this).removeClass("dragging"),h=null}),o.on("dragover",".feature-item",function(a){if(a.preventDefault(),!h||h[0]===this)return;const s=e(this).data("index"),o=h.data("index");o<s?e(this).after(h):e(this).before(h);const i=c.splice(o,1)[0],n=o<s?s-1:s;c.splice(n,0,i),u(),l(t("Item reordered","affiliate-product-showcase"))}),o.on("click",".feature-text",function(t){t.preventDefault();const a=e(this),s=a.closest(".feature-item").data("index"),o="object"==typeof c[s]?c[s].text:c[s],i=e("<input>").attr("type","text").addClass("aps-input aps-input-flex").val(o);function r(){const e=i.val().trim();e&&e!==o&&("object"==typeof c[s]?c[s].text=e:c[s]=e,p()),u()}a.replaceWith(i),i.focus().select(),i.on("blur",r),i.on("keypress",function(e){e.which===n&&(e.preventDefault(),i.off("blur"),r())}),i.on("keydown",function(e){e.which===d&&(e.preventDefault(),i.off("blur"),u())})}),o.on("mousedown",".drag-handle",function(){e(this).closest(".feature-item").attr("draggable","true")}),o.on("mouseup",".drag-handle",function(){e(this).closest(".feature-item").attr("draggable","false")}),u()}()})}(jQuery);