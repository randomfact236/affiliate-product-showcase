#!/bin/sh
#!/bin/sh
# Git pre-commit hook: enforce single source of truth for plan files.
#
# Rule:
# - Do NOT edit generated files manually.
# - Only `plan/plan_source.md` and `plan/plan_state.json` are sources.
#
# Enforcement:
# - If generated plan files are staged, then at least one source file must also be staged.
# - Always run: `node plan/manage-plan.js validate --staged`

set -e

ROOT=$(git rev-parse --show-toplevel 2>/dev/null || echo ".")
cd "$ROOT"

staged=$(git diff --cached --name-only)

if echo "$staged" | grep -E '^plan/(plan_sync.md|plan_sync_todo.md|plan_todos.json)$' >/dev/null 2>&1; then
  if ! echo "$staged" | grep -E '^plan/(plan_source.md|plan_state.json)$' >/dev/null 2>&1; then
    echo "ERROR: Generated plan files are staged without source changes." >&2
    echo "Edit plan/plan_source.md or plan/plan_state.json, then run:" >&2
    echo "  node plan/manage-plan.js regenerate" >&2
    exit 1
  fi
fi

if ! command -v node >/dev/null 2>&1; then
  echo "ERROR: node is required to validate plan workflow." >&2
  exit 2
fi

node plan/manage-plan.js validate --staged

exit 0
