#!/bin/sh
# Copy of the repository pre-push hook. Place this file into .git/hooks/pre-push
# to enable a single-Enter confirmation before pushing (or allow bypass via env var).

remote_name="$1"
remote_url="$2"
if [ -n "$remote_name" ] || [ -n "$remote_url" ]; then
  echo "About to push to ${remote_name:-(remote)} ${remote_url:-(url)}"
fi

# Allow bypass in CI or explicit environment variable
if [ -n "$GIT_PUSH_ALLOW" ] || [ -n "$SKIP_PRE_PUSH_CONFIRM" ] || [ -n "$CI" ]; then
  echo "Bypass enabled via environment; proceeding."
  exit 0
fi

# On Windows try a native Allow/Deny dialog via PowerShell; otherwise fall back to a simple ENTER confirmation
if command -v pwsh >/dev/null 2>&1; then
  pwsh -NoProfile -Command "try { Add-Type -AssemblyName System.Windows.Forms; $msg = 'Proceed with push to ${remote_name:-origin} ${remote_url:-}'; $r = [System.Windows.Forms.MessageBox]::Show($msg,'Confirm',[System.Windows.Forms.MessageBoxButtons]::YesNo); if ($r -eq [System.Windows.Forms.DialogResult]::Yes) { exit 0 } else { exit 1 } } catch { exit 1 }"
  exit $?
fi
if command -v powershell >/dev/null 2>&1; then
  powershell -NoProfile -Command "try { Add-Type -AssemblyName System.Windows.Forms; $msg = 'Proceed with push to ${remote_name:-origin} ${remote_url:-}'; $r = [System.Windows.Forms.MessageBox]::Show($msg,'Confirm',[System.Windows.Forms.MessageBoxButtons]::YesNo); if ($r -eq [System.Windows.Forms.DialogResult]::Yes) { exit 0 } else { exit 1 } } catch { exit 1 }"
  exit $?
fi

# Fallback for interactive TTYs: read from /dev/tty if available (don't consume git's stdin)
if [ -e /dev/tty ]; then
  printf "Press ENTER to allow push to %s (Ctrl+C to abort): " "${remote_name:-origin}"
  read _ < /dev/tty
  exit 0
fi
if [ -t 0 ]; then
  printf "Press ENTER to allow push to %s (Ctrl+C to abort): " "${remote_name:-origin}"
  read _
  exit 0
fi

echo "Non-interactive shell detected. To bypass confirmation set GIT_PUSH_ALLOW=1 or SKIP_PRE_PUSH_CONFIRM=1, or run 'git push --no-verify'."
exit 1
